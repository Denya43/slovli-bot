import json
import re
from typing import List, Tuple

from telegram import Update
from telegram.ext import ContextTypes

from .config import ATTEMPTS, WORD_LEN, TOKEN, WORDS_FILE, ADMIN_USER_ID
from .db import (
    clear_game,
    finish_game_and_update_stats,
    get_chat_leaderboard,
    get_chat_stats,
    get_game,
    get_stats,
    init_db,
    record_chat_win,
    save_game,
    update_chat_stats,
    get_chat_settings,
    save_chat_settings,
    get_custom_words,
    add_custom_word,
    remove_custom_word,
)
from .game import (
    letters_aggregate,
    load_words,
    normalize_word,
    pick_answer,
    score_guess,
    get_words_for_length,
)
from .render import reply_with_grid_image


WORDS_ALL: List[str] = []
ANSWER_POOL: List[str] = []
WORDS_BY_LENGTH: dict = {}
ANSWER_POOLS_BY_LENGTH: dict = {}

def set_word_lists(words_all: List[str], answer_pool: List[str]) -> None:
    global WORDS_ALL, ANSWER_POOL
    WORDS_ALL = words_all
    ANSWER_POOL = answer_pool

def set_words_by_length(words_by_length: dict, answer_pools_by_length: dict) -> None:
    global WORDS_BY_LENGTH, ANSWER_POOLS_BY_LENGTH
    WORDS_BY_LENGTH = words_by_length
    ANSWER_POOLS_BY_LENGTH = answer_pools_by_length


def display_name(update: Update) -> str:
    u = update.effective_user
    return (u.first_name or u.username or "–ò–≥—Ä–æ–∫")


def key_chat_id(update: Update) -> int:
    return update.effective_chat.id


async def cmd_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = key_chat_id(update)
    settings = get_chat_settings(chat_id)
    word_length = settings["word_length"] if settings else 5
    
    await update.message.reply_text(
        f"–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ ¬´–°–ª–æ–≤–ª–∏¬ª ‚Äî —É–≥–∞–¥–∞–π —Å–ª–æ–≤–æ –∏–∑ {word_length} –±—É–∫–≤ –∑–∞ {ATTEMPTS} –ø–æ–ø—ã—Ç–æ–∫.\n"
        "–û–¥–Ω–∞ –∏–≥—Ä–∞ –Ω–∞ —á–∞—Ç. –ö–æ–º–∞–Ω–¥—ã: /new, /giveup, /stats, /help"
    )


async def cmd_help(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = key_chat_id(update)
    settings = get_chat_settings(chat_id)
    word_length = settings["word_length"] if settings else 5
    
    help_text = (
        "–ü—Ä–∞–≤–∏–ª–∞:\n"
        "üü© ‚Äî –±—É–∫–≤–∞ –Ω–∞ —Å–≤–æ—ë–º –º–µ—Å—Ç–µ\n"
        "üü® ‚Äî –±—É–∫–≤–∞ –µ—Å—Ç—å, –Ω–æ –Ω–µ –Ω–∞ –º–µ—Å—Ç–µ\n"
        "‚¨õ ‚Äî –±—É–∫–≤—ã –Ω–µ—Ç –≤ —Å–ª–æ–≤–µ\n\n"
        f"–ü–∏—à–∏ —Å–ª–æ–≤–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π, —Ä–æ–≤–Ω–æ {word_length} –±—É–∫–≤.\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/new ‚Äî –Ω–æ–≤–∞—è –∏–≥—Ä–∞\n"
        "/giveup ‚Äî —Å–¥–∞—Ç—å—Å—è\n"
        "/stats ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
        "/length [—á–∏—Å–ª–æ] ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–ª–∏–Ω—É —Å–ª–æ–≤–∞ (4-9)\n"
        "/checkword [—Å–ª–æ–≤–æ] ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–ª–æ–≤–æ –≤ —Å–ª–æ–≤–∞—Ä–µ\n"
        "/help ‚Äî —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞"
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
    if update.effective_user.id == ADMIN_USER_ID:
        help_text += "\n\n–ê–¥–º–∏–Ω –∫–æ–º–∞–Ω–¥—ã:\n"
        help_text += "/addword <—Å–ª–æ–≤–æ> ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ\n"
        help_text += "/removeword <—Å–ª–æ–≤–æ> ‚Äî —É–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–æ\n"
        help_text += "/words [–¥–ª–∏–Ω–∞] ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–ª–æ–≤"
    
    await update.message.reply_text(help_text)


async def cmd_new(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = key_chat_id(update)
    g = get_game(chat_id)
    if g and g["status"] == "IN_PROGRESS":
        clear_game(chat_id)
        await update.message.reply_text(f"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—Ç–≤–µ—Ç –±—ã–ª: {g['answer']}")

    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞
    settings = get_chat_settings(chat_id)
    word_length = settings["word_length"] if settings else 5
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –ø—É–ª —Å–ª–æ–≤ –¥–ª—è –¥–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã
        pool = ANSWER_POOLS_BY_LENGTH.get(word_length, [])
        if not pool:
            await update.message.reply_text(f"–ù–µ—Ç —Å–ª–æ–≤ –¥–ª–∏–Ω–æ–π {word_length} –±—É–∫–≤ –≤ —Å–ª–æ–≤–∞—Ä–µ.")
            return
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–ª–æ–≤–∞
        custom_words = get_custom_words(word_length)
        pool = pool + custom_words
        
        if not pool:
            await update.message.reply_text(f"–ù–µ—Ç —Å–ª–æ–≤ –¥–ª–∏–Ω–æ–π {word_length} –±—É–∫–≤ –≤ —Å–ª–æ–≤–∞—Ä–µ.")
            return
        
        answer = pick_answer(pool, word_length)
        print(f"[DEBUG] –ó–∞–≥–∞–¥–∞–Ω–æ –¥–ª—è —á–∞—Ç–∞ {chat_id}: {answer} (–¥–ª–∏–Ω–∞: {word_length})")
        save_game(chat_id, answer, [], "IN_PROGRESS", word_length)
        await update.message.reply_text(
            f"–ü–æ–µ—Ö–∞–ª–∏! –ó–∞–≥–∞–¥–∞–Ω–æ —Å–ª–æ–≤–æ –∏–∑ {word_length} –±—É–∫–≤. –£ –≤–∞—Å {ATTEMPTS} –ø–æ–ø—ã—Ç–æ–∫."
        )
    except Exception as e:
        await update.message.reply_text(f"–û—à–∏–±–∫–∞: {e}")


async def cmd_giveup(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = key_chat_id(update)
    g = get_game(chat_id)
    if not g or g["status"] != "IN_PROGRESS":
        await update.message.reply_text("–°–µ–π—á–∞—Å –Ω–µ—Ç –∏–≥—Ä—ã. /new ‚Äî –Ω–∞—á–∞—Ç—å.")
        return
    answer = g["answer"]
    clear_game(chat_id)
    await update.message.reply_text(f"–°–¥–∞—ë–º—Å—è. –û—Ç–≤–µ—Ç –±—ã–ª: {answer}\n/new ‚Äî –Ω–æ–≤–∞—è –∏–≥—Ä–∞")


async def cmd_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    st = get_stats(user_id)
    if not st or st["played"] == 0:
        await update.message.reply_text("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—É—Å—Ç–∞. –°—ã–≥—Ä–∞–π /new!")
        return
    winrate = round(100 * st["wins"] / st["played"])
    await update.message.reply_text(
        f"–°—ã–≥—Ä–∞–Ω–æ: {st['played']}\n"
        f"–ü–æ–±–µ–¥: {st['wins']} ({winrate}%)\n"
        f"–°–µ—Ä–∏—è: {st['current_streak']}, —Ä–µ–∫–æ—Ä–¥: {st['max_streak']}"
    )


async def on_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    msg = update.message.text
    chat_id = key_chat_id(update)
    user_id = update.effective_user.id
    name = display_name(update)

    g = get_game(chat_id)
    if not g or g["status"] != "IN_PROGRESS":
        return

    tokens = re.findall(r"[–ê-–Ø–Å–∞-—è—ë]+", msg)
    if len(tokens) != 1:
        return

    guess = normalize_word(tokens[0])
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª–∏–Ω—ã —Å–ª–æ–≤–∞
    settings = get_chat_settings(chat_id)
    word_length = settings["word_length"] if settings else 5
    
    if len(guess) != word_length:
        await update.message.reply_text(f"–ù—É–∂–Ω–æ —Å–ª–æ–≤–æ –∏–∑ {word_length} –±—É–∫–≤.")
        return
    if not re.fullmatch(r"[–ê-–Ø]{" + str(word_length) + "}", guess):
        await update.message.reply_text("–¢–æ–ª—å–∫–æ –∫–∏—Ä–∏–ª–ª–∏—Ü–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –∏ —Å–∏–º–≤–æ–ª–æ–≤.")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ–≤–æ –≤ —Å–ª–æ–≤–∞—Ä–µ –¥–ª—è –¥–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã
    words_for_length = get_words_for_length(word_length, WORDS_BY_LENGTH.get(word_length, []), get_custom_words(word_length))
    if guess not in words_for_length:
        await update.message.reply_text("–¢–∞–∫–æ–≥–æ —Å–ª–æ–≤–∞ –Ω–µ—Ç –≤ —Å–ª–æ–≤–∞—Ä–µ.")
        return

    answer = g["answer"]
    attempts = json.loads(g["attempts_json"])  # —Å–ø–∏—Å–æ–∫: [guess, marks, user_id]

    # –ó–∞–ø—Ä–µ—Ç–∏–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Ç–µ–º –∂–µ —Å–ª–æ–≤–æ–º –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π –∏–≥—Ä—ã (–¥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ö–æ–¥–∞)
    previous_guesses = {a[0] for a in attempts}
    if guess in previous_guesses:
        await update.message.reply_text("–≠—Ç–æ —Å–ª–æ–≤–æ —É–∂–µ –ø—Ä–æ–±–æ–≤–∞–ª–∏ –≤ —ç—Ç–æ–π –∏–≥—Ä–µ.")
        return

    marks = score_guess(guess, answer)
    attempts.append([guess, marks, user_id])

    if guess == answer:
        finish_game_and_update_stats(user_id, True, len(attempts))
        update_chat_stats(chat_id, True, len(attempts))
        record_chat_win(chat_id, user_id, name)
        clear_game(chat_id)
        await reply_with_grid_image(update, [(a[0], a[1]) for a in attempts], word_length)
        st = get_chat_stats(chat_id)
        if st and st["played"]:
            winrate = round(100 * st["wins"] / st["played"])
            leaderboard = get_chat_leaderboard(chat_id, limit=10)
            lb_text = "\n".join(
                f"{i+1}. {row['name'] or row['user_id']}: {row['wins']}"
                for i, row in enumerate(leaderboard)
            ) or "–Ω–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π"
            await update.message.reply_text(
                f"{guess} ‚Äî {name}\n–ü–æ–±–µ–¥–∞ –∑–∞ {len(attempts)} –ø–æ–ø—ã—Ç–æ–∫! üéâ\n\n"
                f"–°—ã–≥—Ä–∞–Ω–æ –≤ —á–∞—Ç–µ: {st['played']}\n"
                f"–ü–æ–±–µ–¥ —á–∞—Ç–∞: {st['wins']} ({winrate}%)\n"
                f"–°–µ—Ä–∏—è: {st['current_streak']}, —Ä–µ–∫–æ—Ä–¥: {st['max_streak']}\n\n"
                f"–¢–æ–ø –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π:\n{lb_text}\n/new"
            )
        else:
            leaderboard = get_chat_leaderboard(chat_id, limit=10)
            lb_text = "\n".join(
                f"{i+1}. {row['name'] or row['user_id']}: {row['wins']}"
                for i, row in enumerate(leaderboard)
            ) or "–Ω–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π"
            await update.message.reply_text(
                f"{guess} ‚Äî {name}\n–ü–æ–±–µ–¥–∞ –∑–∞ {len(attempts)} –ø–æ–ø—ã—Ç–æ–∫! üéâ\n\n"
                f"–¢–æ–ø –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π:\n{lb_text}\n/new"
            )
        return

    if len(attempts) >= ATTEMPTS:
        update_chat_stats(chat_id, False, None)
        clear_game(chat_id)
        await reply_with_grid_image(update, [(a[0], a[1]) for a in attempts], word_length)
        st = get_chat_stats(chat_id)
        if st and st["played"]:
            winrate = round(100 * st["wins"] / st["played"])
            await update.message.reply_text(
                f"{guess} ‚Äî {name}\n–ù–µ –≤—ã—à–ª–æ. –û—Ç–≤–µ—Ç –±—ã–ª: {answer}\n\n"
                f"–°—ã–≥—Ä–∞–Ω–æ –≤ —á–∞—Ç–µ: {st['played']}\n"
                f"–ü–æ–±–µ–¥ —á–∞—Ç–∞: {st['wins']} ({winrate}%)\n"
                f"–°–µ—Ä–∏—è: {st['current_streak']}, —Ä–µ–∫–æ—Ä–¥: {st['max_streak']}\n/new"
            )
        else:
            await update.message.reply_text(
                f"{guess} ‚Äî {name}\n–ù–µ –≤—ã—à–ª–æ. –û—Ç–≤–µ—Ç –±—ã–ª: {answer}\n/new"
            )
        return

    save_game(chat_id, answer, attempts, "IN_PROGRESS")
    left = ATTEMPTS - len(attempts)
    await reply_with_grid_image(update, [(a[0], a[1]) for a in attempts], word_length)
    await update.message.reply_text(
        f"{guess} ‚Äî {name}\n–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: {left}"
    )


def bootstrap_words() -> Tuple[List[str], List[str]]:
    all_words = load_words(WORDS_FILE, WORD_LEN, min_count=1000)
    pool = load_words(WORDS_FILE, WORD_LEN, min_count=1)
    inter = sorted(set(pool) & set(all_words))
    if not inter:
        raise RuntimeError("ANSWER_POOL –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å WORDS_ALL")
    return all_words, inter


async def cmd_length(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–ª–∏–Ω—É —Å–ª–æ–≤–∞ –¥–ª—è —á–∞—Ç–∞"""
    chat_id = key_chat_id(update)
    
    if not context.args:
        # –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –¥–ª–∏–Ω—É
        settings = get_chat_settings(chat_id)
        current_length = settings["word_length"] if settings else 5
        await update.message.reply_text(
            f"–¢–µ–∫—É—â–∞—è –¥–ª–∏–Ω–∞ —Å–ª–æ–≤–∞: {current_length} –±—É–∫–≤\n"
            f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /length <—á–∏—Å–ª–æ> –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è (4-9 –±—É–∫–≤)"
        )
        return
    
    try:
        length = int(context.args[0])
        if length < 4 or length > 9:
            await update.message.reply_text("–î–ª–∏–Ω–∞ —Å–ª–æ–≤–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 4 –¥–æ 9 –±—É–∫–≤.")
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–ª–æ–≤–∞ —Ç–∞–∫–æ–π –¥–ª–∏–Ω—ã
        if length not in WORDS_BY_LENGTH or not WORDS_BY_LENGTH[length]:
            await update.message.reply_text(f"–ù–µ—Ç —Å–ª–æ–≤ –¥–ª–∏–Ω–æ–π {length} –±—É–∫–≤ –≤ —Å–ª–æ–≤–∞—Ä–µ.")
            return
        
        save_chat_settings(chat_id, length)
        await update.message.reply_text(f"–î–ª–∏–Ω–∞ —Å–ª–æ–≤–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: {length} –±—É–∫–≤")
        
    except ValueError:
        await update.message.reply_text("–£–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 4 –¥–æ 9.")


async def cmd_addword(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å–ª–æ–≤–∞—Ä—å"""
    # Debug: –≤—ã–≤–æ–¥–∏–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    user_id = update.effective_user.id
    print(f"[DEBUG] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID: {user_id}, –ê–¥–º–∏–Ω ID: {ADMIN_USER_ID}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    if ADMIN_USER_ID == 0:
        await update.message.reply_text(
            "‚ùå –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!\n\n"
            "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –¥–æ–±–∞–≤—å—Ç–µ:\n"
            "SLOVLI_ADMIN_USER_ID=–≤–∞—à_id\n\n"
            "–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à ID, –Ω–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É @userinfobot"
        )
        return
    
    if user_id != ADMIN_USER_ID:
        await update.message.reply_text(
            f"‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É!\n\n"
            f"–í–∞—à ID: {user_id}\n"
            f"–ê–¥–º–∏–Ω ID: {ADMIN_USER_ID}\n\n"
            "–ï—Å–ª–∏ –≤—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ñ–∞–π–ª–µ .env"
        )
        return
    
    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /addword <—Å–ª–æ–≤–æ>")
        return
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤ –æ–¥–Ω–æ —Å–ª–æ–≤–æ
    word_input = " ".join(context.args)
    word = normalize_word(word_input)
    
    if len(word) < 4 or len(word) > 9:
        await update.message.reply_text("–î–ª–∏–Ω–∞ —Å–ª–æ–≤–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 4 –¥–æ 9 –±—É–∫–≤.")
        return
    
    if not re.fullmatch(r"[–ê-–Ø]{"+str(len(word))+"}", word):
        await update.message.reply_text("–°–ª–æ–≤–æ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ –±—É–∫–≤—ã.")
        return
    
    length = len(word)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–¥–µ —É–∂–µ –µ—Å—Ç—å —Å–ª–æ–≤–æ
    base_words = WORDS_BY_LENGTH.get(length, [])
    custom_words = get_custom_words(length)
    
    in_base = word in base_words
    in_custom = word in custom_words
    
    if add_custom_word(word, length, update.effective_user.id):
        await update.message.reply_text(f"‚úÖ –°–ª–æ–≤–æ '{word}' –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å–ª–æ–≤–∞—Ä—å ({length} –±—É–∫–≤)")
    else:
        if in_custom:
            await update.message.reply_text(f"‚ùå –°–ª–æ–≤–æ '{word}' —É–∂–µ –µ—Å—Ç—å –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Å–ª–æ–≤–∞—Ä–µ")
        elif in_base:
            await update.message.reply_text(f"‚ùå –°–ª–æ–≤–æ '{word}' —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–æ–≤–æ–º —Å–ª–æ–≤–∞—Ä–µ")
        else:
            await update.message.reply_text(f"‚ùå –°–ª–æ–≤–æ '{word}' —É–∂–µ –µ—Å—Ç—å –≤ —Å–ª–æ–≤–∞—Ä–µ (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ –≥–¥–µ)")


async def cmd_removeword(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–£–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–æ –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    if update.effective_user.id != ADMIN_USER_ID:
        await update.message.reply_text("–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        return
    
    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /removeword <—Å–ª–æ–≤–æ>")
        return
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤ –æ–¥–Ω–æ —Å–ª–æ–≤–æ
    word_input = " ".join(context.args)
    word = normalize_word(word_input)
    
    if len(word) < 4 or len(word) > 9:
        await update.message.reply_text("–î–ª–∏–Ω–∞ —Å–ª–æ–≤–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 4 –¥–æ 9 –±—É–∫–≤.")
        return
    
    if not re.fullmatch(r"[–ê-–Ø]{"+str(len(word))+"}", word):
        await update.message.reply_text("–°–ª–æ–≤–æ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ –±—É–∫–≤—ã.")
        return
    
    length = len(word)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–ª–æ–≤–æ
    base_words = WORDS_BY_LENGTH.get(length, [])
    custom_words = get_custom_words(length)
    
    in_base = word in base_words
    in_custom = word in custom_words
    
    if in_base and not in_custom:
        await update.message.reply_text(
            f"‚ùå –°–ª–æ–≤–æ '{word}' –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –±–∞–∑–æ–≤–æ–º —Å–ª–æ–≤–∞—Ä–µ, –∞ –Ω–µ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–ª–æ–≤–∞—Ö.\n"
            f"–£–¥–∞–ª–∏—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–∞, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ /addword"
        )
        return
    
    if remove_custom_word(word, length):
        await update.message.reply_text(f"‚úÖ –°–ª–æ–≤–æ '{word}' —É–¥–∞–ª–µ–Ω–æ –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è")
    else:
        await update.message.reply_text(
            f"‚ùå –°–ª–æ–≤–æ '{word}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Å–ª–æ–≤–∞—Ä–µ\n\n"
            f"–ü—Ä–æ–≤–µ—Ä–∫–∞:\n"
            f"‚Ä¢ –í –±–∞–∑–æ–≤–æ–º —Å–ª–æ–≤–∞—Ä–µ: {'‚úÖ' if in_base else '‚ùå'}\n"
            f"‚Ä¢ –í –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–ª–æ–≤–∞—Ö: {'‚úÖ' if in_custom else '‚ùå'}\n"
            f"‚Ä¢ –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–ª–æ–≤ –¥–ª–∏–Ω–æ–π {length}: {len(custom_words)}"
        )


async def cmd_checkword(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ —Å–ª–æ–≤–æ –≤ —Å–ª–æ–≤–∞—Ä–µ"""
    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /checkword <—Å–ª–æ–≤–æ>")
        return
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤ –æ–¥–Ω–æ —Å–ª–æ–≤–æ
    word_input = " ".join(context.args)
    word = normalize_word(word_input)
    
    if len(word) < 4 or len(word) > 9:
        await update.message.reply_text("–î–ª–∏–Ω–∞ —Å–ª–æ–≤–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 4 –¥–æ 9 –±—É–∫–≤.")
        return
    
    if not re.fullmatch(r"[–ê-–Ø]{"+str(len(word))+"}", word):
        await update.message.reply_text("–°–ª–æ–≤–æ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ –±—É–∫–≤—ã.")
        return
    
    length = len(word)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –±–∞–∑–æ–≤—ã—Ö —Å–ª–æ–≤–∞—Ö
    base_words = WORDS_BY_LENGTH.get(length, [])
    in_base = word in base_words
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–ª–æ–≤–∞—Ö
    custom_words = get_custom_words(length)
    in_custom = word in custom_words
    
    if in_base and in_custom:
        await update.message.reply_text(f"‚úÖ –°–ª–æ–≤–æ '{word}' –µ—Å—Ç—å –≤ –±–∞–∑–æ–≤–æ–º —Å–ª–æ–≤–∞—Ä–µ –ò –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–ª–æ–≤–∞—Ö")
    elif in_base:
        await update.message.reply_text(f"‚úÖ –°–ª–æ–≤–æ '{word}' –µ—Å—Ç—å –≤ –±–∞–∑–æ–≤–æ–º —Å–ª–æ–≤–∞—Ä–µ")
    elif in_custom:
        await update.message.reply_text(f"‚úÖ –°–ª–æ–≤–æ '{word}' –µ—Å—Ç—å –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–ª–æ–≤–∞—Ö")
    else:
        await update.message.reply_text(f"‚ùå –°–ª–æ–≤–æ '{word}' –ù–ï–¢ –≤ —Å–ª–æ–≤–∞—Ä–µ")


async def cmd_words(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–ª–æ–≤"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    if update.effective_user.id != ADMIN_USER_ID:
        await update.message.reply_text("–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        return
    
    if not context.args:
        # –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        stats = []
        for length in range(4, 10):
            base_words = len(WORDS_BY_LENGTH.get(length, []))
            custom_words = len(get_custom_words(length))
            if base_words > 0 or custom_words > 0:
                stats.append(f"{length} –±—É–∫–≤: {base_words} –±–∞–∑–æ–≤—ã—Ö + {custom_words} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö")
        
        await update.message.reply_text("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–ª–æ–≤:\n" + "\n".join(stats))
        return
    
    try:
        length = int(context.args[0])
        if length < 4 or length > 9:
            await update.message.reply_text("–î–ª–∏–Ω–∞ —Å–ª–æ–≤–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 4 –¥–æ 9 –±—É–∫–≤.")
            return
        
        base_words = len(WORDS_BY_LENGTH.get(length, []))
        custom_words = get_custom_words(length)
        
        msg = f"–°–ª–æ–≤–∞ –¥–ª–∏–Ω–æ–π {length} –±—É–∫–≤:\n"
        msg += f"–ë–∞–∑–æ–≤—ã—Ö —Å–ª–æ–≤: {base_words}\n"
        msg += f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–ª–æ–≤: {len(custom_words)}"
        
        if custom_words:
            msg += f"\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–ª–æ–≤–∞:\n{', '.join(custom_words[:20])}"
            if len(custom_words) > 20:
                msg += f"\n... –∏ –µ—â–µ {len(custom_words) - 20}"
        
        await update.message.reply_text(msg)
        
    except ValueError:
        await update.message.reply_text("–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –¥–ª–∏–Ω—É —Å–ª–æ–≤–∞.")



